"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ctor=_interopRequireDefault(require("xe-utils/ctor")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var l=t[r];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(e,l.key,l)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.max,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"message",get:function(){return _tools.UtilTools.getFuncText(this.$options.message)}}]),t}(),_default={methods:{_fullValidate:function(e,t){return this.beginValidate(e,t,!0)},_validate:function(e,t){return this.beginValidate(e,t)},handleValidError:function(e){var t=this;!1===this.validOpts.autoPos?this.emitEvent("valid-error",e):this.handleActived(e,{type:"valid-error",trigger:"call"}).then(function(){return setTimeout(function(){return t.showValidTooltip(e)},10)})},beginValidate:function(e,a,l){var t,u=this,s={},i=this.editRules,c=this.afterFullData,d=this.treeConfig,r=this.treeOpts;!0===e?t=c:e&&(_ctor.default.isFunction(e)?a=e:t=_ctor.default.isArray(e)?e:[e]),t=t||("obsolete"===_conf.default.validFullData?c:this.getInsertRecords().concat(this.getUpdateRecords()));var f=!0,o=[];if(this.lastCallTime=Date.now(),this.validRuleErr=!1,this.clearValidate(),i){var n=this.getColumns(),e=function(r){var e;!l&&u.validRuleErr||(e=[],n.forEach(function(t){!l&&u.validRuleErr||!_ctor.default.has(i,t.property)||e.push(u.validCellRules("all",r,t).catch(function(e){e={rule:e.rule,rules:e.rules,rowIndex:u.getRowIndex(r),row:r,columnIndex:u.getColumnIndex(t),column:t,$table:u};if(s[t.property]||(s[t.property]=[]),s[t.property].push(e),!l)return u.validRuleErr=!0,Promise.reject(e)}))}),o.push(Promise.all(e)))};return d?_ctor.default.eachTree(t,e,r):t.forEach(e),Promise.all(o).then(function(){var e=Object.keys(s);if(e.length)return Promise.reject(s[e[0]][0]);a&&("obsolete"===_conf.default.validArgs?a(f):a())}).catch(function(n){return new Promise(function(e,t){function r(){f=!1,a?("obsolete"===_conf.default.validArgs?a(f,s):a(s),e()):t(s)}function l(){n.cell=u.getCell(n.row,n.column),_tools.DomTools.toView(n.cell),u.handleValidError(n),r()}var i=n.row,o=c.indexOf(i),i=0<o?c[o-1]:i;!1===u.validOpts.autoPos?r():(d?u.scrollToTreeRow(i):u.scrollToRow(i)).then(l)})})}return a&&("obsolete"===_conf.default.validArgs?a(f):a()),Promise.resolve()},hasCellRules:function(t,e,r){var l=this.editRules,r=r.property;if(r&&l){r=_ctor.default.get(l,r);return r&&_ctor.default.find(r,function(e){return"all"===t||!e.trigger||t===e.trigger})}return!1},validCellRules:function(l,i,o,e){var n,a,u=this,t=this.editRules,r=o.property,s=[],c=[];return r&&t&&((n=_ctor.default.get(t,r))&&(a=_ctor.default.isUndefined(e)?_ctor.default.get(i,r):e,n.forEach(function(r){var e,t;"all"!==l&&r.trigger&&l!==r.trigger||(_ctor.default.isFunction(r.validator)?(t="obsolete"===_conf.default.validArgs?new Promise(function(t){r.validator(r,a,function(e){_ctor.default.isError(e)&&(u.validRuleErr=!0,s.push(new Rule({type:"custom",trigger:r.trigger,message:e.message,rule:new Rule(r)}))),t()},{rule:r,rules:n,row:i,column:o,rowIndex:u.getRowIndex(i),columnIndex:u.getColumnIndex(o),$table:u})}):r.validator({cellValue:a,rule:r,rules:n,row:i,rowIndex:u.getRowIndex(i),column:o,columnIndex:u.getColumnIndex(o),$table:u}))&&(_ctor.default.isError(t)?(u.validRuleErr=!0,s.push(new Rule({type:"custom",trigger:r.trigger,message:t.message,rule:new Rule(r)}))):t.catch&&c.push(t.catch(function(e){u.validRuleErr=!0,s.push(new Rule({type:"custom",trigger:r.trigger,message:(e||r).message,rule:new Rule(r)}))}))):(t=(e="number"===r.type)?_ctor.default.toNumber(a):_ctor.default.getSize(a),(r.required&&(null==a||""===a)||e&&isNaN(a)||!isNaN(r.min)&&t<parseFloat(r.min)||!isNaN(r.max)&&t>parseFloat(r.max)||r.pattern&&!(r.pattern.test?r.pattern:new RegExp(r.pattern)).test(a))&&(u.validRuleErr=!0,s.push(new Rule(r)))))}))),Promise.all(c).then(function(){if(s.length){var e={rules:s,rule:s[0]};return Promise.reject(e)}})},_clearValidate:function(){var e=this.$refs.validTip;return Object.assign(this.validStore,{visible:!1,row:null,column:null,content:"",rule:null}),e&&e.visible&&e.close(),this.$nextTick()},triggerValidate:function(t){var r=this,e=this.editConfig,l=this.editStore,i=this.editRules,o=this.validStore,l=l.actived;if(l.row&&i){var l=l.args,n=l.row,a=l.column,u=l.cell;if(this.hasCellRules(t,n,a))return this.validCellRules(t,n,a).then(function(){"row"===e.mode&&o.visible&&o.row===n&&o.column===a&&r.clearValidate()}).catch(function(e){e=e.rule;if(e.trigger&&t!==e.trigger)return Promise.resolve();e={rule:e,row:n,column:a,cell:u};return r.showValidTooltip(e),Promise.reject(e)})}return Promise.resolve()},showValidTooltip:function(e){var t=this,r=this.$refs,l=this.height,i=this.tableData,o=this.validOpts,n=e.rule,a=e.row,u=e.column,s=e.cell,c=r.validTip,d=n.message;this.$nextTick(function(){Object.assign(t.validStore,{row:a,column:u,rule:n,content:d,visible:!0}),c&&("tooltip"===o.message||"default"===o.message&&!l&&i.length<2)&&c.open(s,d),t.emitEvent("valid-error",e)})}}};exports.default=_default;