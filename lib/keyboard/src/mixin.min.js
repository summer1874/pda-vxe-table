"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ctor=_interopRequireDefault(require("xe-utils/ctor")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var browse=_tools.DomTools.browse;function getTargetOffset(e,o){var t,l,n=0,s=0,c=!browse.firefox&&_tools.DomTools.hasClass(e,"vxe-checkbox--label");for(c&&(t=getComputedStyle(e),n-=_ctor.default.toNumber(t.paddingTop),s-=_ctor.default.toNumber(t.paddingLeft));e&&e!==o;)n+=e.offsetTop,s+=e.offsetLeft,e=e.offsetParent,c&&(l=getComputedStyle(e),n-=_ctor.default.toNumber(l.paddingTop),s-=_ctor.default.toNumber(l.paddingLeft));return{offsetTop:n,offsetLeft:s}}function getCheckboxRangeRows(e,o,t,l){var n=0,s=[],c=0<l,r=0<l?l:Math.abs(l)+t.offsetHeight,d=e.afterFullData,l=e.scrollYStore;if(e.scrollYLoad)o=e.getVTRowIndex(o.row),s=c?d.slice(o,o+Math.ceil(r/l.rowHeight)):d.slice(o-Math.floor(r/l.rowHeight)+1,o+1);else for(var i=c?"next":"previous";t&&n<r;)s.push(e.getRowNode(t).item),n+=t.offsetHeight,t=t["".concat(i,"ElementSibling")];return s}var _default={methods:{moveTabSelected:function(e,o,t){var l,n,s,c,r=this,d=this.afterFullData,i=this.visibleColumn,a=this.editConfig,h=this.editOpts,u=this.isSeqColumn,f=Object.assign({},e),m=d.indexOf(f.row),e=i.indexOf(f.column);if(t.preventDefault(),o){for(var g=e-1;0<=g;g--)if(!u(i[g])){s=i[c=g];break}if(!s&&0<m){l=d[n=m-1];for(var C=i.length-1;0<=C;C--)if(!u(i[C])){s=i[c=C];break}}}else{for(var x=e+1;x<i.length;x++)if(!u(i[x])){s=i[c=x];break}if(!s&&m<d.length-1){l=d[n=m+1];for(var p=0;p<i.length;p++)if(!u(i[p])){s=i[c=p];break}}}s&&(l?(f.rowIndex=n,f.row=l):f.rowIndex=m,f.columnIndex=c,f.column=s,f.cell=this.getCell(f.row,f.column),a&&("click"!==h.trigger&&"dblclick"!==h.trigger||("row"===h.mode?this.handleActived(f,t):this.scrollToRow(f.row,f.column).then(function(){return r.handleSelected(f,t)}))))},moveCurrentRow:function(e,o,t){var l,n,s,c=this,r=this.currentRow,d=this.treeConfig,i=this.treeOpts,a=this.afterFullData;t.preventDefault(),r?d?(n=(i=_ctor.default.findTree(a,function(e){return e===r},i)).index,i=i.items,e&&0<n?l=i[n-1]:o&&n<i.length-1&&(l=i[n+1])):(n=this.getVTRowIndex(r),e&&0<n?l=a[n-1]:o&&n<a.length-1&&(l=a[n+1])):l=a[0],l&&(s={$table:this,row:l},this.scrollToRow(l).then(function(){return c.triggerCurrentRowEvent(t,s)}))},moveSelected:function(e,o,t,l,n,s){var c=this,r=this.afterFullData,d=this.visibleColumn,i=this.isSeqColumn,a=Object.assign({},e),h=this.getVTRowIndex(a.row),e=this.getVTColumnIndex(a.column);if(s.preventDefault(),t&&0<h)a.rowIndex=h-1,a.row=r[a.rowIndex];else if(n&&h<r.length-1)a.rowIndex=h+1,a.row=r[a.rowIndex];else if(o&&e){for(var u=e-1;0<=u;u--)if(!i(d[u])){a.columnIndex=u,a.column=d[u];break}}else if(l)for(var f=e+1;f<d.length;f++)if(!i(d[f])){a.columnIndex=f,a.column=d[f];break}this.scrollToRow(a.row,a.column).then(function(){a.cell=c.getCell(a.row,a.column),c.handleSelected(a,s)})},triggerHeaderCellMousedownEvent:function(e,o){var t=this.mouseConfig,l=this.mouseOpts,n=e.currentTarget,s=_tools.DomTools.getEventTargetNode(e,n,"vxe-cell--sort").flag,c=_tools.DomTools.getEventTargetNode(e,n,"vxe-cell--filter").flag;t&&l.area&&this.handleHeaderCellAreaEvent?this.handleHeaderCellAreaEvent(e,Object.assign({cell:n,triggerSort:s,triggerFilter:c},o)):t&&l.checked&&this.handleHeaderCellCheckedEvent(e,Object.assign({cell:n,triggerSort:s,triggerFilter:c},o)),this.focus(),this.closeMenu()},triggerCellMousedownEvent:function(e,o){var t=e.currentTarget;o.cell=t,this.handleCellMousedownEvent(e,o),this.focus(),this.closeFilter(),this.closeMenu()},handleCellMousedownEvent:function(e,o){var t=this.mouseConfig,l=this.mouseOpts,n=this.checkboxConfig,s=this.checkboxOpts,c=this.editConfig,r=this.editOpts,d=o.column;t&&l.area&&this.handleCellAreaEvent?this.handleCellAreaEvent(e,o):t&&l.checked?this.handleCheckedRangeEvent(e,o):(n&&s.range&&this.handleCheckboxRangeEvent(e,o),t&&l.selected&&("seq"===d.type||"index"===d.type||c&&"cell"!==r.mode||this.handleSelected(o,e)))},handleHeaderCellCheckedEvent:function(e,o){var l,n,s,t,c,r,d=this.$el,i=this.tableData,a=this.mouseConfig,h=this.mouseOpts,u=this.elemStore,f=this.handleChecked,m=this.handleHeaderChecked,g=e.button,C=o.column,x=e.currentTarget,p=0===g,g="seq"===C.type||"index"===C.type;a&&h.checked&&(l=u["main-header-list"].children,n=u["main-body-list"].children,g?this.handleAllChecked(e):(this.clearSelected(e),this.clearHeaderChecked(),this.clearIndexChecked(),s=n[0].querySelector(".".concat(C.id)),p&&(t=document.onmousemove,c=document.onmouseup,r=_ctor.default.throttle(function(e){var o=_tools.DomTools.getEventTargetNode(e,d,"vxe-header--column"),t=o.flag,o=o.targetElem;t||(t=(e=_tools.DomTools.getEventTargetNode(e,d,"vxe-body--column")).flag,o=e.targetElem),t&&!_tools.DomTools.hasClass(o,"col--seq")&&(t=[].indexOf.call(o.parentNode.children,o),o=n[n.length-1].children[t],t=l[0].children[t],m(_tools.DomTools.getRowNodes(l,_tools.DomTools.getCellNodeIndex(t),_tools.DomTools.getCellNodeIndex(x))),f(_tools.DomTools.getRowNodes(n,_tools.DomTools.getCellNodeIndex(s),_tools.DomTools.getCellNodeIndex(o))))},80,{leading:!0,trailing:!0}),_tools.DomTools.addClass(d,"c--checked"),document.onmousemove=function(e){e.preventDefault(),e.stopPropagation(),r(e)},document.onmouseup=function(){_tools.DomTools.removeClass(d,"c--checked"),document.onmousemove=t,document.onmouseup=c}),m([[x]]),n.length&&(g=n[n.length-1].querySelector(".".concat(C.id)),p=n[0],C=n[n.length-1],p=p.querySelector(".col--seq"),o.rowIndex=0,o.row=i[0],o.cell=this.getCell(o.row,o.column),this.handleSelected(o,e),this.handleIndexChecked(_tools.DomTools.getRowNodes(n,_tools.DomTools.getCellNodeIndex(p),_tools.DomTools.getCellNodeIndex(C.querySelector(".col--seq")))),this.handleChecked(_tools.DomTools.getRowNodes(n,_tools.DomTools.getCellNodeIndex(s),_tools.DomTools.getCellNodeIndex(g))))))},getCheckboxRangeRows:function(e,o){for(var t=0,l=[],n=0<o?"next":"previous",s=0<o?o:Math.abs(o)+e.offsetHeight;e&&t<s;)l.push(this.getRowNode(e).item),t+=e.offsetHeight,e=e["".concat(n,"ElementSibling")];return l},handleCheckedRangeEvent:function(e,o){var l=this,n=this.$el,t=this.visibleColumn,s=this.editStore,c=this.mouseOpts,r=this.elemStore,d=s.checked,i=o.column,s=e.button,a=e.currentTarget,s=0===s,h="seq"===i.type||"index"===i.type;this.clearHeaderChecked(),this.clearIndexChecked();var u,f,m,g,C,x,p=r["main-body-list"].children,v=r["main-header-list"].children,_=a.parentNode.lastElementChild,T=a.parentNode.firstElementChild;s&&(u=document.onmousemove,f=document.onmouseup,m=_tools.DomTools.getCellNodeIndex(a),x=[].indexOf.call(a.parentNode.children,a),g=v[0].children[x],C=_ctor.default.throttle(function(e){var o,t=_tools.DomTools.getEventTargetNode(e,n,"vxe-body--column"),e=t.flag,t=t.targetElem;e&&(h?(o=t.parentNode.firstElementChild,l.handleChecked(_tools.DomTools.getRowNodes(p,_tools.DomTools.getCellNodeIndex(o.nextElementSibling),_tools.DomTools.getCellNodeIndex(_))),l.handleIndexChecked(_tools.DomTools.getRowNodes(p,_tools.DomTools.getCellNodeIndex(o),_tools.DomTools.getCellNodeIndex(a)))):_tools.DomTools.hasClass(t,"col--seq")||(e=t.parentNode.firstElementChild,o=[].indexOf.call(t.parentNode.children,t),o=v[0].children[o],l.handleHeaderChecked(_tools.DomTools.getRowNodes(v,_tools.DomTools.getCellNodeIndex(o),_tools.DomTools.getCellNodeIndex(g))),l.handleIndexChecked(_tools.DomTools.getRowNodes(p,_tools.DomTools.getCellNodeIndex(e),_tools.DomTools.getCellNodeIndex(T))),l.handleChecked(_tools.DomTools.getRowNodes(p,m,_tools.DomTools.getCellNodeIndex(t)))))},80,{leading:!0,trailing:!0}),document.onmousemove=function(e){e.preventDefault(),e.stopPropagation(),C(e)},document.onmouseup=function(){document.onmousemove=u,document.onmouseup=f}),h?(x=a.parentNode.firstElementChild,o.columnIndex++,o.column=t[o.columnIndex],o.cell=a.nextElementSibling,this.handleSelected(o,e),this.handleChecked(_tools.DomTools.getRowNodes(p,_tools.DomTools.getCellNodeIndex(x.nextElementSibling),_tools.DomTools.getCellNodeIndex(_))),this.handleHeaderChecked([v[0].querySelectorAll(".vxe-header--column:not(.col--seq)")]),this.handleIndexChecked(_tools.DomTools.getRowNodes(p,_tools.DomTools.getCellNodeIndex(x),_tools.DomTools.getCellNodeIndex(a)))):s?(s=a.parentNode.firstElementChild,this.handleSelected(o,e),this.handleHeaderChecked([[v[0].querySelector(".".concat(i.id))]]),this.handleIndexChecked([[s]])):c.selected&&(d.rowNodes&&d.rowNodes.some(function(e){return-1<e.indexOf(a)})||this.handleSelected(o,e))},handleCheckboxRangeEvent:function(e,r){var o,t,d,i,a,h,l,n,u,f,m,g,C,x,p,v,_,T,y,k,b,s,w=this,c=r.column,D=r.cell;0===e.button&&-1<["checkbox","selection"].indexOf(c.type)&&(o=this.$el,t=this.elemStore,d=e.clientX,i=e.clientY,a=t["".concat(c.fixed||"main","-body-wrapper")]||t["main-body-wrapper"],h=a.querySelector(".vxe-table--checkbox-range"),l=document.onmousemove,n=document.onmouseup,u=D.parentNode,f=this.getCheckboxRecords(),m=[],D=getTargetOffset(e.target,a),g=D.offsetTop+e.offsetY,C=D.offsetLeft+e.offsetX,x=a.scrollTop,p=u.offsetHeight,v=null,_=!1,T=1,y=function(e,o){w.emitEvent("checkbox-range-".concat(e),{records:w.getCheckboxRecords(),reserves:w.getCheckboxReserveRecords()},o)},k=function(e){var o=e.clientX,t=e.clientY,l=o-d,n=t-i+(a.scrollTop-x),s=Math.abs(n),c=Math.abs(l),o=g,t=C;n<1?(o+=n)<1&&(o=1,s=g):s=Math.min(s,a.scrollHeight-g-1),l<1?(t+=l,C<c&&(t=1,c=C)):c=Math.min(c,a.clientWidth-C-1),h.style.height="".concat(s,"px"),h.style.width="".concat(c,"px"),h.style.left="".concat(t,"px"),h.style.top="".concat(o,"px"),h.style.display="block";n=getCheckboxRangeRows(w,r,u,n<1?-s:s);10<s&&n.length!==m.length&&(m=n,e.ctrlKey?n.forEach(function(e){w.handleSelectRow({row:e},-1===f.indexOf(e))}):(w.setAllCheckboxRow(!1),w.setCheckboxRow(n,!0)),y("change",e))},b=function(){clearTimeout(v),v=null},s=function s(c){b(),v=setTimeout(function(){var e,o,t,l,n;v&&(e=a.scrollLeft,o=a.scrollTop,t=a.clientHeight,l=a.scrollHeight,n=Math.ceil(50*T/p),_?o+t<l?(w.scrollTo(e,o+n),s(c),k(c)):b():o?(w.scrollTo(e,o-n),s(c),k(c)):b())},50)},_tools.DomTools.addClass(o,"drag--area"),document.onmousemove=function(e){e.preventDefault(),e.stopPropagation();var o=e.clientY,t=_tools.DomTools.getAbsolutePos(a).boundingTop;o<t?(_=!1,T=t-o,v||s(e)):o>t+a.clientHeight?(_=!0,T=o-t-a.clientHeight,v||s(e)):v&&b(),k(e)},document.onmouseup=function(e){b(),_tools.DomTools.removeClass(o,"drag--area"),h.removeAttribute("style"),document.onmousemove=l,document.onmouseup=n,y("end",e)},y("start",e))},_clearChecked:function(){var e=this.$refs,o=this.editStore,t=this.mouseConfig,l=this.mouseOpts,o=o.checked;return t&&l.checked&&(e=e.tableBody,o.rows=[],o.columns=[],o.tRows=[],o.tColumns=[],e.$refs.checkBorders.style.display="none",_ctor.default.arrayEach(e.$el.querySelectorAll(".col--checked"),function(e){return _tools.DomTools.removeClass(e,"col--checked")})),this.$nextTick()},_getMouseSelecteds:function(){return _tools.UtilTools.warn("vxe.error.delFunc",["getMouseSelecteds","getSelectedCell"]),this.getSelectedCell()},_getMouseCheckeds:function(){return this.getSelectedRanges()},_getSelectedCell:function(){var e=this.editStore.selected,o=e.args,e=e.column;return o&&e?Object.assign({},o):null},_getSelectedRanges:function(){var o=this,e=this.editStore.checked.rowNodes,t=void 0===e?[]:e,l=[],e=[];return t&&t.length&&(e=t.map(function(e){return o.getRowNode(e[0].parentNode).item}),l=t[0].map(function(e){return o.getColumnNode(e).item})),{columns:l,rows:e,rowNodes:t}},handleChecked:function(e){var o=this.editStore.checked;this.clearChecked();var l=-2,n=-2,s=0,c=0;_ctor.default.arrayEach(e,function(e,o){var t=0===o;_ctor.default.arrayEach(e,function(e,o){o=0===o;o&&t&&(s=e.offsetTop,c=e.offsetLeft),t&&(l+=e.offsetWidth),o&&(n+=e.offsetHeight),_tools.DomTools.addClass(e,"col--checked")})});var t=this.$refs.tableBody.$refs,r=t.checkBorders,d=t.checkTop,i=t.checkRight,a=t.checkBottom,t=t.checkLeft;r.style.display="block",Object.assign(d.style,{top:"".concat(s,"px"),left:"".concat(c,"px"),width:"".concat(l,"px")}),Object.assign(i.style,{top:"".concat(s,"px"),left:"".concat(c+l,"px"),height:"".concat(n,"px")}),Object.assign(a.style,{top:"".concat(s+n,"px"),left:"".concat(c,"px"),width:"".concat(l,"px")}),Object.assign(t.style,{top:"".concat(s,"px"),left:"".concat(c,"px"),height:"".concat(n,"px")}),o.rowNodes=e},handleAllChecked:function(e){var o,t,l,n=this.tableData,s=this.visibleColumn,c=this.mouseConfig,r=this.mouseOpts,d=this.elemStore;c&&r.checked&&(e.preventDefault(),o=(l=d["main-header-list"]).children,t=d["main-body-list"].children,c=_ctor.default.find(s,function(e){return"seq"===e.type||"index"===e.type})||s[0],r=l.querySelector(".".concat(c.id)),d=t[0],l=t[t.length-1],d=d.querySelector(".".concat(c.id)),(s={$table:this,rowIndex:0,row:n[0],column:_ctor.default.find(s,function(e){return e.property})}).columnIndex=this.getColumnIndex(s.column),s.cell=this.getCell(s.row,s.column),this.handleSelected(s,e),this.handleHeaderChecked(_tools.DomTools.getRowNodes(o,_tools.DomTools.getCellNodeIndex(r.nextElementSibling),_tools.DomTools.getCellNodeIndex(r.parentNode.lastElementChild))),this.handleIndexChecked(_tools.DomTools.getRowNodes(t,_tools.DomTools.getCellNodeIndex(d),_tools.DomTools.getCellNodeIndex(l.querySelector(".".concat(c.id))))),this.handleChecked(_tools.DomTools.getRowNodes(t,_tools.DomTools.getCellNodeIndex(d.nextElementSibling),_tools.DomTools.getCellNodeIndex(l.lastElementChild))))},handleIndexChecked:function(e){var o=this.editStore.indexs;this.clearIndexChecked(),_ctor.default.arrayEach(e,function(e){_ctor.default.arrayEach(e,function(e){_tools.DomTools.addClass(e,"col--seq-checked")})}),o.rowNodes=e},_clearIndexChecked:function(){var e=this.elemStore["main-body-list"];return _ctor.default.arrayEach(e.querySelectorAll(".col--seq-checked"),function(e){return _tools.DomTools.removeClass(e,"col--seq-checked")}),this.$nextTick()},handleHeaderChecked:function(e){var o=this.editStore.titles;this.clearHeaderChecked(),_ctor.default.arrayEach(e,function(e){_ctor.default.arrayEach(e,function(e){_tools.DomTools.addClass(e,"col--title-checked")})}),o.rowNodes=e},_clearHeaderChecked:function(){var e=this.elemStore["main-header-list"];return e&&_ctor.default.arrayEach(e.querySelectorAll(".col--title-checked"),function(e){return _tools.DomTools.removeClass(e,"col--title-checked")}),this.$nextTick()},_clearCopyed:function(){var e=this.$refs,o=this.editStore,t=this.keyboardConfig,o=o.copyed;return t&&t.isCut&&(t=e.tableBody,e=e.tableBody.$refs.copyBorders,o.cut=!1,o.rows=[],o.columns=[],e.style.display="none",_ctor.default.arrayEach(t.$el.querySelectorAll(".col--copyed"),function(e){return _tools.DomTools.removeClass(e,"col--copyed")})),this.$nextTick()},handleCopyed:function(e){var o=this.tableData,t=this.tableColumn,l=this.editStore,n=l.copyed,s=l.checked.rowNodes;this.clearCopyed();var c=-3,r=-3,d=0,i=0,a=[],l=[];s.length&&(u=s[0],f=(h=_tools.DomTools.getCellNodeIndex(u[0])).rowIndex,h=h.columnIndex,a=t.slice(h,h+u.length),l=o.slice(f,f+s.length)),_ctor.default.arrayEach(s,function(e,o){var t=0===o;_ctor.default.arrayEach(e,function(e,o){o=0===o;o&&t&&(d=e.offsetTop,i=e.offsetLeft),t&&(c+=e.offsetWidth),o&&(r+=e.offsetHeight),_tools.DomTools.addClass(e,"col--copyed")})});var t=this.$refs.tableBody.$refs,h=t.copyBorders,u=t.copyTop,o=t.copyRight,f=t.copyBottom,t=t.copyLeft;h.style.display="block",Object.assign(u.style,{top:"".concat(d,"px"),left:"".concat(i,"px"),width:"".concat(c,"px")}),Object.assign(o.style,{top:"".concat(d,"px"),left:"".concat(i+c,"px"),height:"".concat(r,"px")}),Object.assign(f.style,{top:"".concat(d+r,"px"),left:"".concat(i,"px"),width:"".concat(c,"px")}),Object.assign(t.style,{top:"".concat(d,"px"),left:"".concat(i,"px"),height:"".concat(r,"px")}),n.cut=e,n.rows=l,n.columns=a,n.rowNodes=s},handlePaste:function(){var o,n,s=this.tableData,c=this.visibleColumn,e=this.editStore,t=this.elemStore,l=e.copyed,r=e.selected,d=l.cut,i=l.rows,a=l.columns;i.length&&a.length&&r.row&&r.column&&(e=r.args,o=e.rowIndex,n=e.columnIndex,_ctor.default.arrayEach(i,function(t,e){var l=s[o+e];l&&_ctor.default.arrayEach(a,function(e,o){o=c[n+o];o&&_tools.UtilTools.setCellValue(l,o,_tools.UtilTools.getCellValue(t,e)),d&&_tools.UtilTools.setCellValue(t,e,null)})}),d&&this.clearCopyed(),l=t["main-body-list"].children,t=(e=r.args.cell).parentNode,r=_ctor.default.arrayIndexOf(t.children,e),r=l[_ctor.default.arrayIndexOf(l,t)+i.length-1].children[r+a.length-1],this.handleChecked(_tools.DomTools.getRowNodes(l,_tools.DomTools.getCellNodeIndex(e),_tools.DomTools.getCellNodeIndex(r))))}}};exports.default=_default;