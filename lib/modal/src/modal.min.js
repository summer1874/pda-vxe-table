"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _conf=_interopRequireDefault(require("../../conf")),_ctor=_interopRequireDefault(require("xe-utils/ctor")),_queue=_interopRequireDefault(require("./queue")),_activities=_interopRequireDefault(require("./activities")),_tools=require("../../tools");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var o=Object.prototype.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var o=0,i=new Array(e);o<e;o++)i[o]=t[o];return i}function _iterableToArrayLimit(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var o=[],i=!0,n=!1,s=void 0;try{for(var a,l=t[Symbol.iterator]();!(i=(a=l.next()).done)&&(o.push(a.value),!e||o.length!==e);i=!0);}catch(t){n=!0,s=t}finally{try{i||null==l.return||l.return()}finally{if(n)throw s}}return o}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var activeModals=[],_default2={name:"VxeModal",props:{value:Boolean,id:String,type:{type:String,default:"modal"},loading:{type:Boolean,default:null},status:String,iconStatus:String,className:String,top:{type:[Number,String],default:15},position:[String,Object],title:String,duration:{type:[Number,String],default:function(){return _conf.default.modal.duration}},message:[String,Function],cancelButtonText:String,confirmButtonText:String,lockView:{type:Boolean,default:function(){return _conf.default.modal.lockView}},lockScroll:Boolean,mask:{type:Boolean,default:function(){return _conf.default.modal.mask}},maskClosable:Boolean,escClosable:Boolean,resize:Boolean,showHeader:{type:Boolean,default:!0},showFooter:Boolean,dblclickZoom:{type:Boolean,default:function(){return _conf.default.modal.dblclickZoom}},width:[Number,String],height:[Number,String],minWidth:{type:[Number,String],default:function(){return _conf.default.modal.minWidth}},minHeight:{type:[Number,String],default:function(){return _conf.default.modal.minHeight}},zIndex:Number,marginSize:{type:[Number,String],default:_conf.default.modal.marginSize},fullscreen:Boolean,remember:{type:Boolean,default:function(){return _conf.default.modal.remember}},destroyOnClose:Boolean,showTitleOverflow:{type:Boolean,default:function(){return _conf.default.modal.showTitleOverflow}},transfer:{type:Boolean,default:function(){return _conf.default.modal.transfer}},storage:{type:Boolean,default:function(){return _conf.default.modal.storage}},storageKey:{type:String,default:function(){return _conf.default.modal.storageKey}},animat:{type:Boolean,default:function(){return _conf.default.modal.animat}},size:{type:String,default:function(){return _conf.default.modal.size||_conf.default.size}},slots:Object,events:Object},data:function(){return{inited:!1,visible:!1,contentVisible:!1,modalTop:0,modalZindex:0,zoomLocat:null,firstOpen:!1}},computed:{vSize:function(){return this.size||this.$parent&&(this.$parent.size||this.$parent.vSize)},isMsg:function(){return"message"===this.type}},watch:{width:function(){this.recalculate()},height:function(){this.recalculate()},value:function(t){this[t?"open":"close"]()}},created:function(){this.storage&&!this.id&&_tools.UtilTools.error("vxe.error.reqProp",["modal.id"]),activeModals.push(this)},mounted:function(){var t=this.$listeners,e=this.events,o=void 0===e?{}:e;this.value&&this.open(),this.recalculate(),this.escClosable&&_tools.GlobalEvent.on(this,"keydown",this.handleGlobalKeydownEvent);e="inserted",e={type:e,$modal:this,$event:{type:e}};t.inserted?this.$emit("inserted",e):o.inserted&&o.inserted.call(this,e)},beforeDestroy:function(){var e=this,t=this.$el;_tools.GlobalEvent.off(this,"keydown"),this.removeMsgQueue(),t.parentNode===document.body&&t.parentNode.removeChild(t),_ctor.default.remove(activeModals,function(t){return t===e})},render:function(e){var o=this,t=this.$scopedSlots,i=this.slots,n=void 0===i?{}:i,s=this.inited,a=this.vSize,l=this.className,r=this.type,c=this.resize,u=this.animat,d=this.loading,h=this.status,f=this.iconStatus,m=this.showFooter,p=this.zoomLocat,v=this.modalTop,g=this.dblclickZoom,y=this.contentVisible,x=this.visible,b=this.title,_=this.message,w=this.lockScroll,S=this.lockView,z=this.mask,$=this.isMsg,T=this.showTitleOverflow,k=this.destroyOnClose,B=t.default||n.default,N=t.footer||n.footer,i=t.header||n.header,t=t.title||n.title,n={mousedown:this.mousedownEvent};return c&&g&&"modal"===r&&(n.dblclick=this.toggleZoomEvent),e("div",{class:["vxe-modal--wrapper","type--".concat(r),l,(_defineProperty(l={},"size--".concat(a),a),_defineProperty(l,"status--".concat(h),h),_defineProperty(l,"is--animat",u),_defineProperty(l,"lock--scroll",w),_defineProperty(l,"lock--view",S),_defineProperty(l,"is--mask",z),_defineProperty(l,"is--maximize",p),_defineProperty(l,"is--visible",y),_defineProperty(l,"is--active",x),_defineProperty(l,"is--loading",d),l)],style:{zIndex:this.modalZindex,top:v?"".concat(v,"px"):null},on:{click:this.selfClickEvent}},[e("div",{class:"vxe-modal--box",on:{mousedown:this.boxMousedownEvent},ref:"modalBox"},[this.showHeader?e("div",{class:["vxe-modal--header",!$&&T?"is--ellipsis":""],on:n},i?!s||k&&!x?[]:i.call(this,{$modal:this},e):[t?t.call(this,{$modal:this},e):e("span",{class:"vxe-modal--title"},b?_tools.UtilTools.getFuncText(b):_conf.default.i18n("vxe.alert.title")),c?e("i",{class:["vxe-modal--zoom-btn","trigger--btn",p?_conf.default.icon.MODAL_ZOOM_OUT:_conf.default.icon.MODAL_ZOOM_IN],attrs:{title:_conf.default.i18n("vxe.modal.zoom".concat(p?"Out":"In"))},on:{click:this.toggleZoomEvent}}):null,e("i",{class:["vxe-modal--close-btn","trigger--btn",_conf.default.icon.MODAL_CLOSE],attrs:{title:_conf.default.i18n("vxe.modal.close")},on:{click:this.closeEvent}})]):null,e("div",{class:"vxe-modal--body"},[h?e("div",{class:"vxe-modal--status-wrapper"},[e("i",{class:["vxe-modal--status-icon",f||_conf.default.icon["MODAL_".concat(h).toLocaleUpperCase()]]})]):null,e("div",{class:"vxe-modal--content"},B?!s||k&&!x?[]:B.call(this,{$modal:this},e):_tools.UtilTools.getFuncText(_)),$?null:e("div",{class:["vxe-loading",{"is--visible":d}]},[e("div",{class:"vxe-loading--spinner"})])]),m?e("div",{class:"vxe-modal--footer"},N?!s||k&&!x?[]:N.call(this,{$modal:this},e):["confirm"===r?e("vxe-button",{ref:"cancelBtn",on:{click:this.cancelEvent}},this.cancelButtonText||_conf.default.i18n("vxe.button.cancel")):null,e("vxe-button",{ref:"confirmBtn",props:{status:"primary"},on:{click:this.confirmEvent}},this.confirmButtonText||_conf.default.i18n("vxe.button.confirm"))]):null,!$&&c?e("span",{class:"vxe-modal--resize"},["wl","wr","swst","sest","st","swlb","selb","sb"].map(function(t){return e("span",{class:"".concat(t,"-resize"),attrs:{"data-type":t},on:{mousedown:o.dragEvent}})})):null])])},methods:{recalculate:function(){var t=this.width,e=this.height,o=this.getBox();return o.style.width=t?isNaN(t)?t:"".concat(t,"px"):null,o.style.height=e?isNaN(e)?e:"".concat(e,"px"):null,this.$nextTick()},selfClickEvent:function(t){this.maskClosable&&t.target===this.$el&&this.close("mask")},updateZindex:function(){var t=this.zIndex,e=this.modalZindex;t?this.modalZindex=t:e<_tools.UtilTools.getLastZIndex()&&(this.modalZindex=_tools.UtilTools.nextZIndex())},closeEvent:function(t){var e="close";this.$emit(e,{type:e,$modal:this,$event:t},t),this.close(e)},confirmEvent:function(t){var e="confirm";this.$emit(e,{type:e,$modal:this,$event:t},t),this.close(e)},cancelEvent:function(t){var e="cancel";this.$emit(e,{type:e,$modal:this,$event:t},t),this.close(e)},open:function(){var e,o=this,i=this.$refs,t=this.events,n=void 0===t?{}:t,s=this.inited,a=this.duration,l=this.visible,t=this.isMsg,r=this.remember,c=this.showFooter;s||(this.inited=!0,this.transfer&&document.body.appendChild(this.$el)),l||(e={type:"show",$modal:this,$event:{type:"show"}},r||this.recalculate(),this.visible=!0,this.contentVisible=!1,this.updateZindex(),_activities.default.push(this),this.$emit("activated",e),setTimeout(function(){o.contentVisible=!0,o.$nextTick(function(){var t;!c||(t=i.confirmBtn||i.cancelBtn)&&t.focus(),n.show?n.show.call(o,e):(o.$emit("input",!0),o.$emit("show",e))})},10),t?(this.addMsgQueue(),-1!==a&&setTimeout(this.close,_ctor.default.toNumber(a))):this.$nextTick(function(){var t=o.firstOpen,e=o.fullscreen;r&&t||o.updatePosition().then(function(){setTimeout(function(){return o.updatePosition()},20)}),t||(o.firstOpen=!0,o.hasPosStorage()?o.restorePosStorage():e&&o.$nextTick(function(){return o.maximize()}))}))},addMsgQueue:function(){-1===_queue.default.indexOf(this)&&_queue.default.push(this),this.updateStyle()},removeMsgQueue:function(){var e=this;-1<_queue.default.indexOf(this)&&_ctor.default.remove(_queue.default,function(t){return t===e}),this.updateStyle()},updateStyle:function(){this.$nextTick(function(){var e=0;_queue.default.forEach(function(t){e+=_ctor.default.toNumber(t.top),t.modalTop=e,e+=t.$refs.modalBox.clientHeight})})},updatePosition:function(){var u=this;return this.$nextTick().then(function(){var t=u.marginSize,e=u.position,o=u.getBox(),i=document.documentElement.clientWidth||document.body.clientWidth,n=document.documentElement.clientHeight||document.body.clientHeight,s="center"===e,a=s?{top:e,left:e}:Object.assign({},e),l=a.top,r=a.left,c=s||"center"===l,e="",a="",a=r&&!(s||"center"===r)?isNaN(r)?r:"".concat(r,"px"):"".concat(Math.max(t,i/2-o.offsetWidth/2),"px"),e=l&&!c?isNaN(l)?l:"".concat(l,"px"):"".concat(Math.max(t,n/2-o.offsetHeight/2),"px");o.style.top=e,o.style.left=a})},close:function(t){var e=this,o=this.events,i=void 0===o?{}:o,n=this.remember,s=this.visible,o=this.isMsg,a={type:t,$modal:this,$event:{type:t}};s&&(o&&this.removeMsgQueue(),this.contentVisible=!1,n||(this.zoomLocat=null),this.$emit("deactivated",a),_ctor.default.remove(_activities.default,function(t){return t===e}),setTimeout(function(){e.visible=!1,i.hide?i.hide.call(e,a):(e.$emit("input",!1),e.$emit("hide",a))},200))},handleGlobalKeydownEvent:function(t){var e,o=this;27!==t.keyCode||(e=_ctor.default.max(_activities.default,function(t){return t.modalZindex}))&&setTimeout(function(){e===o&&e.escClosable&&o.close()},10)},getBox:function(){return this.$refs.modalBox},isMaximized:function(){return!!this.zoomLocat},maximize:function(){var n=this;return this.$nextTick().then(function(){var t,e,o,i;n.resize&&!n.zoomLocat&&(t=n.marginSize,e=n.getBox(),o=(i=_tools.DomTools.getDomNode()).visibleHeight,i=i.visibleWidth,n.zoomLocat={top:e.offsetTop,left:e.offsetLeft,width:e.offsetWidth+(e.style.width?0:1),height:e.offsetHeight+(e.style.height?0:1)},Object.assign(e.style,{top:"".concat(t,"px"),left:"".concat(t,"px"),width:"".concat(i-2*t,"px"),height:"".concat(o-2*t,"px")}),n.savePosStorage())})},revert:function(){var o=this;return this.$nextTick().then(function(){var t,e=o.zoomLocat;e&&(t=o.getBox(),o.zoomLocat=null,Object.assign(t.style,{top:"".concat(e.top,"px"),left:"".concat(e.left,"px"),width:"".concat(e.width,"px"),height:"".concat(e.height,"px")}),o.savePosStorage())})},zoom:function(){var t=this;return this[this.zoomLocat?"revert":"maximize"]().then(function(){return t.isMaximized()})},toggleZoomEvent:function(t){var e=this,o=this.$listeners,i=this.zoomLocat,n=this.events,s=void 0===n?{}:n,a={type:i?"revert":"max",$modal:this,$event:t};return this.zoom().then(function(){o.zoom?e.$emit("zoom",a,t):s.zoom&&s.zoom.call(e,a,t)})},getPosition:function(){if(!this.isMsg){var t=this.getBox();if(t)return{top:t.offsetTop,left:t.offsetLeft}}return null},setPosition:function(t,e){var o;return this.isMsg||(o=this.getBox(),_ctor.default.isNumber(t)&&(o.style.top="".concat(t,"px")),_ctor.default.isNumber(e)&&(o.style.left="".concat(e,"px"))),this.$nextTick()},boxMousedownEvent:function(){var e=this.modalZindex;activeModals.some(function(t){return t.visible&&t.modalZindex>e})&&this.updateZindex()},mousedownEvent:function(t){var e,o,n,s,a,l,i=this,r=this.remember,c=this.storage,u=this.marginSize,d=this.zoomLocat,h=this.getBox();d||0!==t.button||_tools.DomTools.getEventTargetNode(t,h,"trigger--btn").flag||(t.preventDefault(),e=document.onmousemove,o=document.onmouseup,n=t.clientX-h.offsetLeft,s=t.clientY-h.offsetTop,t=_tools.DomTools.getDomNode(),a=t.visibleHeight,l=t.visibleWidth,document.onmousemove=function(t){t.preventDefault();var e=h.offsetWidth,o=h.offsetHeight,i=l-e-u-1,e=a-o-u-1,o=t.clientX-n,t=t.clientY-s;i<o&&(o=i),o<u&&(o=u),e<t&&(t=e),t<u&&(t=u),h.style.left="".concat(o,"px"),h.style.top="".concat(t,"px")},document.onmouseup=function(){document.onmousemove=e,document.onmouseup=o,r&&c&&i.$nextTick(function(){i.savePosStorage()})})},dragEvent:function(t){var s=this;t.preventDefault();var a=this.$listeners,l=this.marginSize,e=this.events,r=void 0===e?{}:e,c=this.remember,u=this.storage,e=_tools.DomTools.getDomNode(),d=e.visibleHeight,h=e.visibleWidth,f=t.target.dataset.type,m=_ctor.default.toNumber(this.minWidth),p=_ctor.default.toNumber(this.minHeight),v=h,g=d,y=this.getBox(),o=document.onmousemove,i=document.onmouseup,x=y.clientWidth,b=y.clientHeight,_=t.clientX,w=t.clientY,S=y.offsetTop,z=y.offsetLeft,$={type:"resize",$modal:this};document.onmousemove=function(t){var e,o,i,n;switch(t.preventDefault(),f){case"wl":i=(e=_-t.clientX)+x,l<z-e&&m<i&&(y.style.width="".concat(i<v?i:v,"px"),y.style.left="".concat(z-e,"px"));break;case"swst":e=_-t.clientX,o=w-t.clientY,i=e+x,n=o+b,l<z-e&&m<i&&(y.style.width="".concat(i<v?i:v,"px"),y.style.left="".concat(z-e,"px")),l<S-o&&p<n&&(y.style.height="".concat(n<g?n:g,"px"),y.style.top="".concat(S-o,"px"));break;case"swlb":e=_-t.clientX,o=t.clientY-w,i=e+x,n=o+b,l<z-e&&m<i&&(y.style.width="".concat(i<v?i:v,"px"),y.style.left="".concat(z-e,"px")),S+n+l<d&&p<n&&(y.style.height="".concat(n<g?n:g,"px"));break;case"st":o=w-t.clientY,n=b+o,l<S-o&&p<n&&(y.style.height="".concat(n<g?n:g,"px"),y.style.top="".concat(S-o,"px"));break;case"wr":e=t.clientX-_,z+(i=e+x)+l<h&&m<i&&(y.style.width="".concat(i<v?i:v,"px"));break;case"sest":e=t.clientX-_,n=(o=w-t.clientY)+b,z+(i=e+x)+l<h&&m<i&&(y.style.width="".concat(i<v?i:v,"px")),l<S-o&&p<n&&(y.style.height="".concat(n<g?n:g,"px"),y.style.top="".concat(S-o,"px"));break;case"selb":e=t.clientX-_,n=(o=t.clientY-w)+b,z+(i=e+x)+l<h&&m<i&&(y.style.width="".concat(i<v?i:v,"px")),S+n+l<d&&p<n&&(y.style.height="".concat(n<g?n:g,"px"));break;case"sb":o=t.clientY-w,S+(n=o+b)+l<d&&p<n&&(y.style.height="".concat(n<g?n:g,"px"))}y.className=y.className.replace(/\s?is--drag/,"")+" is--drag",c&&u&&s.savePosStorage(),a.zoom?s.$emit("zoom",$,t):r.zoom&&r.zoom.call(s,$,t)},document.onmouseup=function(){s.zoomLocat=null,document.onmousemove=o,document.onmouseup=i,setTimeout(function(){y.className=y.className.replace(/\s?is--drag/,"")},50)}},getStorageMap:function(t){var e=_conf.default.version,t=_ctor.default.toStringJSON(localStorage.getItem(t));return t&&t._v===e?t:{_v:e}},hasPosStorage:function(){var t=this.id,e=this.remember,o=this.storage,i=this.storageKey;return!!(e&&o&&this.getStorageMap(i)[t])},restorePosStorage:function(){var t,e,o,i,n,s=this.id,a=this.remember,l=this.storage,r=this.storageKey;a&&l&&((i=this.getStorageMap(r)[s])&&(t=this.getBox(),e=(n=_slicedToArray(i.split(","),8))[0],o=n[1],a=n[2],l=n[3],r=n[4],s=n[5],i=n[6],n=n[7],e&&(t.style.left="".concat(e,"px")),o&&(t.style.top="".concat(o,"px")),a&&(t.style.width="".concat(a,"px")),l&&(t.style.height="".concat(l,"px")),r&&s&&(this.zoomLocat={left:r,top:s,width:i,height:n})))},savePosStorage:function(){var t=this.id,e=this.remember,o=this.storage,i=this.storageKey,n=this.zoomLocat;e&&o&&(e=this.getBox(),(o=this.getStorageMap(i))[t]=[e.style.left,e.style.top,e.style.width,e.style.height].concat(n?[n.left,n.top,n.width,n.height]:[]).map(function(t){return t?_ctor.default.toNumber(t):""}).join(","),localStorage.setItem(i,_ctor.default.toJSONString(o)))}}};exports.default=_default2;