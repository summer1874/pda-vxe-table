"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ctor=_interopRequireDefault(require("xe-utils/ctor")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}var _default={methods:{_insert:function(e){return this.insertAt(e)},_insertAt:function(e,t){var r=this,o=this.mergeList,l=this.afterFullData,i=this.editStore,n=this.sYOpts,s=this.scrollYLoad,a=this.tableFullData,c=this.treeConfig;_ctor.default.isArray(e)||(e=[e]);var u=e.map(function(e){return r.defineField(Object.assign({},e))});if(t)if(-1===t)l.push.apply(l,_toConsumableArray(u)),a.push.apply(a,_toConsumableArray(u)),o.forEach(function(e){var t=e.row,r=e.rowspan;t+r>l.length&&(e.rowspan=r+u.length)});else{if(c)throw new Error(_tools.UtilTools.getLog("vxe.error.noTree",["insert"]));var d=l.indexOf(t);if(-1===d)throw new Error(_tools.UtilTools.error("vxe.error.unableInsert"));l.splice.apply(l,_toConsumableArray([d,0].concat(u))),a.splice.apply(a,_toConsumableArray([a.indexOf(t),0].concat(u))),o.forEach(function(e){var t=e.row,r=e.rowspan;d<t?e.row=t+u.length:d<t+r&&(e.rowspan=r+u.length)})}else l.unshift.apply(l,_toConsumableArray(u)),a.unshift.apply(a,_toConsumableArray(u)),o.forEach(function(e){var t=e.row;0<t&&(e.row=t+u.length)});return(i=i.insertList).unshift.apply(i,_toConsumableArray(u)),this.scrollYLoad=!c&&-1<n.gt&&n.gt<a.length,this.handleTableData(),this.updateFooter(),this.updateCache(),this.checkSelectionStatus(),s&&this.updateScrollYSpace(),this.$nextTick().then(function(){return r.recalculate(),{row:u.length?u[u.length-1]:null,rows:u}})},_remove:function(e){var t=this,r=this.afterFullData,l=this.tableFullData,o=this.treeConfig,i=this.mergeList,n=this.editStore,s=this.checkboxOpts,a=this.selection,c=this.isInsertByRow,u=this.sYOpts,d=this.scrollYLoad,h=n.actived,f=n.removeList,v=n.insertList,s=s.checkField,m=[];return e?_ctor.default.isArray(e)||(e=[e]):e=l,e.forEach(function(e){c(e)||f.push(e)}),s||e.forEach(function(e){e=a.indexOf(e);-1<e&&a.splice(e,1)}),l===e?(e=m=l.slice(0),this.tableFullData=[],this.afterFullData=[],this.clearMergeCells()):e.forEach(function(e){var t=l.indexOf(e);-1<t&&(t=l.splice(t,1),m.push(t[0]));var o=r.indexOf(e);-1<o&&(i.forEach(function(e){var t=e.row,r=e.rowspan;o<t?e.row=t-1:o<t+r&&(e.rowspan=r-1)}),r.splice(o,1))}),h.row&&-1<e.indexOf(h.row)&&this.clearActived(),e.forEach(function(e){e=v.indexOf(e);-1<e&&v.splice(e,1)}),this.scrollYLoad=!o&&-1<u.gt&&u.gt<l.length,this.handleTableData(),this.updateFooter(),this.updateCache(),this.checkSelectionStatus(),d&&this.updateScrollYSpace(),this.$nextTick().then(function(){return t.recalculate(),{row:m.length?m[m.length-1]:null,rows:m}})},_removeSelecteds:function(){return _tools.UtilTools.warn("vxe.error.delFunc",["removeSelecteds","removeCheckboxRow"]),this.removeCheckboxRow()},_removeCheckboxRow:function(){var t=this;return this.remove(this.getCheckboxRecords()).then(function(e){return t.clearCheckboxRow(),e})},_removeRadioRow:function(){var t=this,e=this.getRadioRecord();return this.remove(e||[]).then(function(e){return t.clearRadioRow(),e})},_removeCurrentRow:function(){var t=this,e=this.getCurrentRecord();return this.remove(e||[]).then(function(e){return t.clearCurrentRow(),e})},_getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:this.getUpdateRecords()}},_getInsertRecords:function(){var t=this.editStore.insertList,r=[];return t.length&&this.tableFullData.forEach(function(e){-1<t.indexOf(e)&&r.push(e)}),r},_getRemoveRecords:function(){return this.editStore.removeList},_getUpdateRecords:function(){var e=this.keepSource,t=this.tableFullData,r=this.isUpdateByRow,o=this.treeConfig,l=this.treeOpts;return e||_tools.UtilTools.warn("vxe.error.reqProp",["keep-source"]),e?o?_ctor.default.filterTree(t,function(e){return r(e)},l):t.filter(function(e){return r(e)}):[]},handleActived:function(e,t){var r,o=this,l=this.editStore,i=this.editOpts,n=this.tableColumn,s=i.mode,a=i.activeMethod,c=l.actived,u=e.row,i=e.column,l=e.cell;return i.editRender&&l&&(c.row!==u||"cell"===s&&c.column!==i?(r="edit-disabled",a&&!a(e)||(this.mouseConfig&&(this.clearCopyed(t),this.clearChecked(),this.clearSelected(t),this.clearCellAreas(t),this.clearCopyCellArea(t)),this.clostTooltip(),this.clearActived(t),r="edit-actived",i.renderHeight=l.offsetHeight,c.args=e,c.row=u,c.column=i,"row"===s?n.forEach(function(e){return o._getColumnModel(u,e)}):this._getColumnModel(u,i),this.$nextTick(function(){o.handleFocus(e,t)})),this.emitEvent(r,e,t)):((n=c.column)!==i&&((r=n.model).update&&_tools.UtilTools.setCellValue(u,n,r.value),this.clearValidate()),i.renderHeight=l.offsetHeight,c.args=e,c.column=i,setTimeout(function(){o.handleFocus(e,t)})),this.focus()),this.$nextTick()},_getColumnModel:function(e,t){var r=t.model;t.editRender&&(r.value=_tools.UtilTools.getCellValue(e,t),r.update=!1)},_setColumnModel:function(e,t){var r=t.model;t.editRender&&r.update&&(_tools.UtilTools.setCellValue(e,t,r.value),r.update=!1,r.value=null)},_clearActived:function(e){var t=this,r=this.tableColumn,o=this.editStore,l=this.editOpts,i=o.actived,n=i.args,s=i.row,o=i.column;return(s||o)&&("row"===l.mode?r.forEach(function(e){return t._setColumnModel(s,e)}):this._setColumnModel(s,o),this.updateFooter(),this.emitEvent("edit-closed",n,e)),i.args=null,i.row=null,i.column=null,(_vXETable.default._valid?this.clearValidate():this.$nextTick()).then(this.recalculate)},_getActiveRow:function(){return _tools.UtilTools.warn("vxe.error.delFunc",["getActiveRow","getActiveRecord"]),this.getActiveRecord()},_getActiveRecord:function(){var e=this.$el,t=this.editStore,r=this.afterFullData,o=t.actived,t=o.args,o=o.row;return t&&-1<r.indexOf(o)&&e.querySelectorAll(".vxe-body--column.col--actived").length?Object.assign({},t):null},_hasActiveRow:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["hasActiveRow","isActiveByRow"]),this.isActiveByRow(e)},_isActiveByRow:function(e){return this.editStore.actived.row===e},handleFocus:function(e){var t,r,o=e.row,l=e.column,i=e.cell,n=l.editRender;n&&(t=_vXETable.default.renderer.get(n.name),e=n.autofocus,n=n.autoselect,e&&(r=i.querySelector(e)),!r&&t&&t.autofocus&&(r=i.querySelector(t.autofocus)),r?(r.focus(),n?r.select():_tools.DomTools.browse.msie&&((r=r.createTextRange()).collapse(!1),r.select())):this.scrollToRow(o,l))},_setActiveRow:function(e){return this.setActiveCell(e,_ctor.default.find(this.visibleColumn,function(e){return e.editRender}).property)},_setActiveCell:function(r,o){var l=this;return this.scrollToRow(r,!0).then(function(){var e,t;return r&&o&&((e=_ctor.default.find(l.visibleColumn,function(e){return e.property===o}))&&e.editRender&&((t=l.getCell(r,e))&&(l.handleActived({row:r,rowIndex:l.getRowIndex(r),column:e,columnIndex:l.getColumnIndex(e),cell:t,$table:l}),l.lastCallTime=Date.now()))),l.$nextTick()})},_setSelectCell:function(e,t){var r,o=this.tableData,l=this.editOpts,i=this.visibleColumn;return e&&t&&"manual"!==l.trigger&&(r=_ctor.default.find(i,function(e){return e.property===t}),-1<(l=o.indexOf(e))&&r&&(o=this.getCell(e,r),o={row:e,rowIndex:l,column:r,columnIndex:i.indexOf(r),cell:o},this.handleSelected(o,{}))),this.$nextTick()},handleSelected:function(e,t){var r,o=this,l=this.mouseConfig,i=this.mouseOpts,n=this.editOpts,s=this.editStore,a=this.elemStore,c=s.actived,u=s.selected,d=e.row,h=e.column,f=e.cell,v=l&&i.selected,m=l&&i.checked;return!v&&!m||u.row===d&&u.column===h||(c.row!==d||"cell"===n.mode&&c.column!==h)&&(o.keyboardConfig&&(o.clearChecked(t),o.clearIndexChecked(),o.clearHeaderChecked()),o.clearActived(t),o.clearSelected(t),o.clearCellAreas(t),o.clearCopyCellArea(t),u.args=e,u.row=d,u.column=h,v&&o.addColSdCls(),m&&(r=a["main-header-list"],o.handleChecked([[f]]),r&&o.handleHeaderChecked([[r.querySelector(".".concat(h.id))]]),o.handleIndexChecked([[f.parentNode.querySelector(".col--seq")]])),o.focus()),o.$nextTick()},_clearSelected:function(){var e=this.editStore.selected;return e.row=null,e.column=null,this.reColTitleSdCls(),this.reColSdCls(),this.$nextTick()},reColTitleSdCls:function(){var e=this.elemStore["main-header-list"];e&&_ctor.default.arrayEach(e.querySelectorAll(".col--title-selected"),function(e){return _tools.DomTools.removeClass(e,"col--title-selected")})},reColSdCls:function(){var e=this.$el.querySelector(".col--selected");e&&_tools.DomTools.removeClass(e,"col--selected")},addColSdCls:function(){var e=this.editStore.selected,t=e.row,e=e.column;this.reColSdCls(),t&&e&&((e=this.getCell(t,e))&&_tools.DomTools.addClass(e,"col--selected"))}}};exports.default=_default;