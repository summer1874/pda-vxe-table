"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ctor=_interopRequireDefault(require("xe-utils/ctor")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var l=Object.prototype.toString.call(e).slice(8,-1);return"Object"===l&&e.constructor&&(l=e.constructor.name),"Map"===l||"Set"===l?Array.from(e):"Arguments"===l||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(l)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var l=0,r=new Array(t);l<t;l++)r[l]=e[l];return r}function _defineProperty(e,t,l){return t in e?Object.defineProperty(e,t,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[t]=l,e}var scrollProcessTimeout,cellType="body";function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.delayHover}function countTreeExpand(e,t){var l=t.$table,r=e[l.treeOpts.children],o=1;if(l.isTreeExpandByRow(e))for(var n=0;n<r.length;n++)o+=countTreeExpand(r[n],t);return o}function getOffsetSize(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function calcTreeLine(e,t){var l=e.$table,r=e.$rowIndex,o=1;return r&&(o=countTreeExpand(t[r-1],e)),l.rowHeight*o-(r?1:12-getOffsetSize(l))}function renderLine(e,t,l,r,o,n){var a=n.column,s=l.treeOpts,c=l.treeConfig;return a.slots&&a.slots.line?a.slots.line.call(l,n,e):a.treeNode&&c&&s.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat(calcTreeLine(n,o),"px"),left:"".concat(r*s.indent+(r?2-getOffsetSize(l):0)+16,"px")}})])]:[]}function renderBorder(e,t){return e("div",{class:"vxe-table-".concat(t,"ed-borders"),ref:"".concat(t,"Borders")},[e("span",{class:"vxe-table-border-top",ref:"".concat(t,"Top")}),e("span",{class:"vxe-table-border-right",ref:"".concat(t,"Right")}),e("span",{class:"vxe-table-border-bottom",ref:"".concat(t,"Bottom")}),e("span",{class:"vxe-table-border-left",ref:"".concat(t,"Left")})])}function mergeMethod(e,t,l){for(var r=0;r<e.length;r++){var o=e[r],n=o.row,a=o.col,s=o.rowspan,o=o.colspan;if(-1<a&&-1<n&&s&&o){if(n===t&&a===l)return{rowspan:s,colspan:o};if(n<=t&&t<n+s&&a<=l&&l<a+o)return{rowspan:0,colspan:0}}}}function renderColumn(e,t,l,r,o,n,a,s,c,i,d,u,p,f,y,v){var g,x=l._e,b=l.$listeners,m=l.afterFullData,h=l.tableData,w=l.height,_=l.columnKey,T=l.overflowX,S=l.scrollXLoad,C=l.scrollYLoad,O=l.highlightCurrentRow,$=l.showOverflow,L=l.align,k=l.currentColumn,E=l.cellClassName,I=l.cellStyle,R=l.mergeList,B=l.spanMethod,A=l.radioOpts,P=l.checkboxOpts,q=l.expandOpts,D=l.treeOpts,M=l.tooltipOpts,H=l.mouseConfig,j=l.editConfig,N=l.editOpts,U=l.editRules,X=l.validOpts,z=l.editStore,F=l.validStore,W=p.cellRender,Y=p.editRender,V=p.align,K=p.showOverflow,G=p.className,J=p.treeNode,Q=z.actived,Z=M.enabled,ee=l.getColumnIndex(p),te=l.getVTColumnIndex(p),z=a?p.fixed!==a:p.fixed&&T,M=_ctor.default.isUndefined(K)||_ctor.default.isNull(K)?$:K,T="ellipsis"===M,le="title"===M,re=!0===M||"tooltip"===M,K=le||re||T,M={},V=V||L,L=F.row===c&&F.column===p,U=U&&("default"===X.message?w||1<h.length:"inline"===X.message),w={"data-colid":p.id},oe=b["cell-mouseenter"],ne=b["cell-mouseleave"],X=Y&&j&&"dblclick"===N.trigger,ae={$table:l,$seq:r,seq:o,rowid:n,row:c,rowIndex:i,$rowIndex:d,_rowIndex:u,column:p,columnIndex:ee,$columnIndex:f,_columnIndex:te,fixed:a,type:cellType,isHidden:z,level:s,visibleData:m,data:h,items:v};if(!S&&!C||K||(T=K=!0),(le||re||Z||oe)&&(M.mouseenter=function(e){isOperateMouse(l)||(le?_tools.DomTools.updateCellTitle(e.currentTarget,p):(re||Z)&&l.triggerBodyTooltipEvent(e,ae),oe&&l.emitEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},ae),e))}),(re||Z||ne)&&(M.mouseleave=function(e){isOperateMouse(l)||((re||Z)&&l.handleTargetLeaveEvent(e),ne&&l.emitEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},ae),e))}),(P.range||H)&&(M.mousedown=function(e){l.triggerCellMousedownEvent(e,ae)}),(O||H||b["cell-click"]||Y&&j||"row"===q.trigger||"cell"===q.trigger||"row"===A.trigger||"radio"===p.type&&"cell"===A.trigger||"row"===P.trigger||("checkbox"===p.type||"selection"===p.type)&&"cell"===P.trigger||"row"===D.trigger||p.treeNode&&"cell"===D.trigger)&&(M.click=function(e){l.triggerCellClickEvent(e,ae)}),(X||b["cell-dblclick"])&&(M.dblclick=function(e){l.triggerCellDBLClickEvent(e,ae)}),R.length){u=mergeMethod(R,u,te);if(u){var te=u.rowspan,se=u.colspan;if(!te||!se)return null;1<te&&(w.rowspan=te),1<se&&(w.colspan=se)}}else if(B){se=B(ae)||{},B=se.rowspan,B=void 0===B?1:B,se=se.colspan,se=void 0===se?1:se;if(!B||!se)return null;1<B&&(w.rowspan=B),1<se&&(w.colspan=se)}z&&R&&(1<w.colspan||1<w.rowspan)&&(z=!1),!z&&j&&(Y||W)&&N.showStatus&&(g=l.isUpdateByRow(c,p.property));R="seq"===p.type||"index"===p.type?"seq":p.type;return e("td",{class:["vxe-body--column",p.id,(_defineProperty(W={},"col--".concat(V),V),_defineProperty(W,"col--".concat(R),R),_defineProperty(W,"col--last",f===y.length-1),_defineProperty(W,"col--tree-node",J),_defineProperty(W,"col--edit",!!Y),_defineProperty(W,"col--ellipsis",K),_defineProperty(W,"fixed--hidden",z),_defineProperty(W,"col--dirty",g),_defineProperty(W,"col--actived",j&&Y&&Q.row===c&&(Q.column===p||"row"===N.mode)),_defineProperty(W,"col--valid-error",L),_defineProperty(W,"col--current",k===p),W),_tools.UtilTools.getClass(G,ae),_tools.UtilTools.getClass(E,ae)],key:_?p.id:f,attrs:w,style:I?_ctor.default.isFunction(I)?I(ae):I:null,on:M},$&&z?[e("div",{class:["vxe-cell",{"c--title":le,"c--tooltip":re,"c--ellipsis":T}]})]:renderLine(e,t,l,s,v,ae).concat([e("div",{class:["vxe-cell",{"c--title":le,"c--tooltip":re,"c--ellipsis":T}],attrs:{title:le?_tools.UtilTools.getCellLabel(c,p,ae):null}},p.renderCell(e,ae)),U?L?e("div",{class:"vxe-cell--valid",style:F.rule&&F.rule.maxWidth?{width:"".concat(F.rule.maxWidth,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},F.content)]):x():null]))}function renderRows(d,u,p,f,y,v,g,x){var b=p.stripe,m=p.rowKey,h=p.highlightHoverRow,w=p.rowClassName,_=p.rowStyle,T=p.showOverflow,S=p.treeConfig,C=p.treeOpts,O=p.treeExpandeds,$=p.scrollYLoad,L=p.scrollYStore,k=p.editStore,E=p.rowExpandeds,I=p.radioOpts,R=p.checkboxOpts,B=p.expandColumn,A=[];return g.forEach(function(l,r){var e={},o=(a=r)+1;$&&(o+=L.startIndex);var n=p.getVTRowIndex(l),a=p.getRowIndex(l);h&&(e.mouseenter=function(e){isOperateMouse(p)||p.triggerHoverEvent(e,{row:l,rowIndex:a})},e.mouseleave=function(){isOperateMouse(p)||p.clearHoverRow()});var t,s,c=_tools.UtilTools.getRowid(p,l),i={$table:p,$seq:f,seq:o,rowid:c,fixed:v,type:cellType,level:y,row:l,rowIndex:a,$rowIndex:r};A.push(d("tr",{class:["vxe-body--row",{"row--stripe":b&&(p.getVTRowIndex(l)+1)%2==0,"is--new":-1<k.insertList.indexOf(l),"row--radio":I.highlight&&p.selectRow===l,"row--checked":R.highlight&&p.isCheckedByCheckboxRow(l)},w?_ctor.default.isFunction(w)?w(i):w:""],attrs:{"data-rowid":c},style:_?_ctor.default.isFunction(_)?_(i):_:null,key:m||S?c:r,on:e},x.map(function(e,t){return renderColumn(d,u,p,f,o,c,v,y,l,a,r,n,e,t,x,g)}))),B&&E.length&&-1<E.indexOf(l)&&(s=p.getColumnIndex(B),S&&(t={paddingLeft:"".concat(y*C.indent+30,"px")}),i=B.showOverflow,i=_ctor.default.isUndefined(i)||_ctor.default.isNull(i)?T:i,s={$table:p,$seq:f,seq:o,column:B,columnIndex:s,fixed:v,type:cellType,level:y,row:l,rowIndex:a,$rowIndex:r},A.push(d("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(c),style:_?_ctor.default.isFunction(_)?_(s):_:null,on:e},[d("td",{class:["vxe-body--expanded-column",{"fixed--hidden":v,"col--ellipsis":i}],attrs:{colspan:x.length}},[d("div",{class:"vxe-body--expanded-cell",style:t},[B.renderData(d,s)])])]))),S&&O.length&&((s=l[C.children])&&s.length&&-1<O.indexOf(l)&&A.push.apply(A,_toConsumableArray(renderRows(d,u,p,(f?"".concat(f,"."):"").concat(o),y+1,v,s,x))))}),A}function syncBodyScroll(e,t,l){(t||l)&&(t&&(t.onscroll=null,t.scrollTop=e),l&&(l.onscroll=null,l.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){t&&(t.onscroll=t._onscroll),l&&(l.onscroll=l._onscroll)},100))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){var e=this.$parent,t=this.$el,l=this.$refs,r=this.fixedType,e=e.elemStore,r="".concat(r||"main","-body-");e["".concat(r,"wrapper")]=t,e["".concat(r,"table")]=l.table,e["".concat(r,"colgroup")]=l.colgroup,e["".concat(r,"list")]=l.tbody,e["".concat(r,"xSpace")]=l.xSpace,e["".concat(r,"ySpace")]=l.ySpace,e["".concat(r,"emptyBlock")]=l.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(l){var e=this._e,t=this.$parent,r=this.fixedColumn,o=this.fixedType,n=t.$scopedSlots,a=t.tId,s=t.tableData,c=t.tableColumn,i=t.showOverflow,d=t.mergeList,u=t.spanMethod,p=t.scrollXLoad,f=t.mouseConfig,y=t.mouseOpts,v=t.emptyRender,g=t.emptyOpts,x=t.keyboardConfig,b=t.keyboardOpts,m=f&&y.checked;return d.length||u||x&&b.isMerge||(o&&i||p&&o)&&(c=r),g=n.empty?n.empty.call(this,{$table:t},l):(v=v?_vXETable.default.renderer.get(g.name):null)&&v.renderEmpty?v.renderEmpty.call(this,l,g,{$table:t},{$table:t}):t.emptyText||_conf.default.i18n("vxe.table.emptyText"),l("div",{class:["vxe-table--body-wrapper",o?"fixed-".concat(o,"--wrapper"):"body--wrapper"],attrs:{"data-tid":a}},[o?e():l("div",{class:"vxe-body--x-space",ref:"xSpace"}),l("div",{class:"vxe-body--y-space",ref:"ySpace"}),l("table",{class:"vxe-table--body",attrs:{"data-tid":a,cellspacing:0,cellpadding:0,border:0},ref:"table"},[l("colgroup",{ref:"colgroup"},c.map(function(e,t){return l("col",{attrs:{name:e.id},key:t})})),l("tbody",{ref:"tbody"},renderRows(l,this,t,"",0,o,s,c))]),o||!m&&!b.isCut?null:l("div",{class:"vxe-table--borders"},[m?renderBorder(l,"check"):null,b.isCut?renderBorder(l,"copy"):null]),l("div",{class:"vxe-table--checkbox-range"}),f&&y.area?l("div",{class:"vxe-table--cell-area"},[l("span",{class:"vxe-table--cell-main-area"},y.extension?[l("span",{class:"vxe-table--cell-main-area-btn",on:{mousedown:function(e){t.triggerCellExtendMousedownEvent(e,{$table:t,fixed:o,type:cellType})}}})]:null),l("span",{class:"vxe-table--cell-copy-area"}),l("span",{class:"vxe-table--cell-extend-area"}),l("span",{class:"vxe-table--cell-multi-area"}),l("span",{class:"vxe-table--cell-active-area"})]):null,o?null:l("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[l("div",{class:"vxe-table--empty-content"},g)])])},methods:{scrollEvent:function(e){var t=this.$el,l=this.$parent,r=this.fixedType,o=l.$refs,n=l.highlightHoverRow,a=l.scrollXLoad,s=l.scrollYLoad,c=l.lastScrollTop,i=l.lastScrollLeft,d=o.tableHeader,u=o.tableBody,p=o.leftBody,f=o.rightBody,y=o.tableFooter,o=o.validTip,v=d?d.$el:null,y=y?y.$el:null,g=u.$el,u=p?p.$el:null,p=f?f.$el:null,f=t.scrollTop,t=g.scrollLeft,i=t!==i,c=f!==c;l.lastScrollTop=f,l.lastScrollLeft=t,l.lastScrollTime=Date.now(),n&&l.clearHoverRow(),u&&"left"===r?syncBodyScroll(f=u.scrollTop,g,p):p&&"right"===r?syncBodyScroll(f=p.scrollTop,g,u):(i&&(v&&(v.scrollLeft=g.scrollLeft),y&&(y.scrollLeft=g.scrollLeft)),(u||p)&&(l.checkScrolling(),c&&syncBodyScroll(f,u,p))),a&&i&&(l.triggerScrollXEvent(e),v&&t+g.clientWidth>=g.scrollWidth-80&&this.$nextTick(function(){g.scrollLeft!==v.scrollLeft&&(v.scrollLeft=g.scrollLeft)})),s&&c&&l.triggerScrollYEvent(e),i&&o&&o.visible&&o.updatePlacement(),l.emitEvent("scroll",{type:cellType,fixed:r,scrollTop:f,scrollLeft:t,isX:i,isY:c},e)}}};exports.default=_default;