"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ctor=_interopRequireDefault(require("xe-utils/ctor")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"message",get:function(){return _tools.UtilTools.getFuncText(this.$options.message)}}]),t}();function getResetValue(e,t){return _ctor.default.isArray(e)&&(t=[]),t}function getItemSlots(e,t){var r,i=e.$scopedSlots,e=t.slots,t={};return e&&(r=e.default)&&i[r]&&(r=i[r]),r&&(t.default=r),t}function renderItems(t,r){var e=r.items;return e?e.map(function(e){return t("vxe-form-item",{props:e,scopedSlots:getItemSlots(r,e)})}):[]}var _default2={name:"VxeForm",props:{loading:Boolean,data:Object,size:{type:String,default:function(){return _conf.default.form.size||_conf.default.size}},span:[String,Number],align:String,titleAlign:String,titleWidth:[String,Number],titleColon:{type:Boolean,default:function(){return _conf.default.form.titleColon}},titleAsterisk:{type:Boolean,default:function(){return _conf.default.form.titleAsterisk}},items:Array,rules:Object,preventSubmit:{type:Boolean,default:function(){return _conf.default.form.preventSubmit}},validConfig:Object},data:function(){return{collapseAll:!0,invalids:[]}},provide:function(){return{$vxeform:this}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},validOpts:function(){return Object.assign({},_conf.default.form.validConfig,this.validConfig)}},render:function(e){var t,r=this.$slots,i=this.loading,n=this.vSize;return e("form",{class:["vxe-form","vxe-row",(_defineProperty(t={},"size--".concat(n),n),_defineProperty(t,"is--colon",this.titleColon),_defineProperty(t,"is--asterisk",this.titleAsterisk),_defineProperty(t,"is--loading",i),t)],on:{submit:this.submitEvent,reset:this.resetEvent}},[].concat(r.default||renderItems(e,this)).concat([e("div",{class:["vxe-loading",{"is--visible":i}]},[e("div",{class:"vxe-loading--spinner"})])]))},methods:{getItems:function(){return this.$children.map(function(e){return{field:e.field,title:e.title,itemRender:e.itemRender}})},toggleCollapse:function(){return this.collapseAll=!this.collapseAll,this.$nextTick()},submitEvent:function(t){var r=this;t.preventDefault(),this.preventSubmit||this.beginValidate().then(function(){r.$emit("submit",{data:r.data,$form:r,$event:t},t)}).catch(function(e){r.$emit("submit-invalid",{data:r.data,errMap:e,$form:r,$event:t},t)})},reset:function(){var i=this,n=this.data;return n&&this.$children.forEach(function(e){var t=e.field,r=e.resetValue,e=e.itemRender;t&&(_ctor.default.set(n,t,null===r?getResetValue(_ctor.default.get(n,t),void 0):r),(e=e?_vXETable.default.renderer.get(e.name):null)&&e.itemResetMethod&&e.itemResetMethod({data:n,property:t,$form:i}))}),this.clearValidate()},resetEvent:function(e){e.preventDefault(),this.reset(),this.$emit("reset",{data:this.data,$form:this,$event:e},e)},clearValidate:function(t){return t?_ctor.default.remove(this.invalids,function(e){return e.property===t}):this.invalids=[],this.$nextTick()},validate:function(e){return this.beginValidate(e)},beginValidate:function(r,e){var i=this,n=this.data,t=this.rules,a=this.validOpts,o={},s=[],u=[];return this.clearValidate(),n&&t?(this.$children.forEach(function(e){var t=e.field;t&&u.push(i.validItemRules(r||"all",t).catch(function(e){e={rule:e.rule,rules:e.rules,data:n,property:t,$form:i};return o[t]||(o[t]=[]),o[t].push(e),s.push(t),i.invalids.push(e),Promise.reject(e)}))}),Promise.all(u).then(function(){e&&e()}).catch(function(){return e&&e(o),!1!==a.autoPos&&i.$nextTick(function(){i.handleFocus(s)}),Promise.reject(o)})):(e&&e(),Promise.resolve())},validItemRules:function(i,n,e){var a,o,s=this,u=this.data,t=this.rules,l=[],c=[];return n&&t&&((a=_ctor.default.get(t,n))&&(o=_ctor.default.isUndefined(e)?_ctor.default.get(u,n):e,a.forEach(function(t){var e,r;"all"!==i&&t.trigger&&i!==t.trigger||(_ctor.default.isFunction(t.validator)?(r=t.validator({itemValue:o,rule:t,rules:a,data:u,property:n,$form:s}))&&(_ctor.default.isError(r)?l.push(new Rule({type:"custom",trigger:t.trigger,message:r.message,rule:new Rule(t)})):r.catch&&c.push(r.catch(function(e){l.push(new Rule({type:"custom",trigger:t.trigger,message:(e||t).message,rule:new Rule(t)}))}))):(r=(e="number"===t.type)?_ctor.default.toNumber(o):_ctor.default.getSize(o),null==o||""===o?t.required&&l.push(new Rule(t)):(e&&isNaN(o)||!isNaN(t.min)&&r<parseFloat(t.min)||!isNaN(t.max)&&r>parseFloat(t.max)||t.pattern&&!(t.pattern.test?t.pattern:new RegExp(t.pattern)).test(o))&&l.push(new Rule(t))))}))),Promise.all(c).then(function(){if(l.length){var e={rules:l,rule:l[0]};return Promise.reject(e)}})},handleFocus:function(e){var a=this.$children;e.some(function(t){var e=_ctor.default.find(a,function(e){return e.field===t});if(e&&e.itemRender){var r,i=e.$el,n=e.itemRender,e=_vXETable.default.renderer.get(n.name);if(n.autofocus&&(r=i.querySelector(n.autofocus)),!r&&e&&e.autofocus&&(r=i.querySelector(e.autofocus)),r)return r.focus(),_tools.DomTools.browse.msie&&((r=r.createTextRange()).collapse(!1),r.select()),!0}})},updateStatus:function(e,t){var i=this,n=e.property;n&&this.validItemRules("change",n,t).then(function(){i.clearValidate(n)}).catch(function(e){var t=e.rule,r=e.rules,e=_ctor.default.find(i.invalids,function(e){return e.property===n});e?(e.rule=t,e.rules=r):i.invalids.push({rule:t,rules:r,property:n})})}}};exports.default=_default2;